<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VPS Chat Platform</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        :root {
            --bg-dark: #36393f;
            --bg-darker: #2f3136;
            --bg-darkest: #202225;
            --channel-width: 240px;
            --accent: #5865F2;
            --text-main: #dcddde;
            --text-muted: #72767d;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        body { background-color: var(--bg-dark); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* --- Login Screen --- */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-darker); display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 1000;
        }
        .login-box {
            background: var(--bg-dark); padding: 40px; border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); text-align: center;
        }
        .login-box h2 { margin-bottom: 20px; color: #fff; }

        /* --- Main App Layout --- */
        #app-container { display: none; height: 100%; width: 100%; }

        /* 1. Server Sidebar (Far Left) */
        .guild-sidebar {
            width: 72px; background: var(--bg-darkest); display: flex;
            flex-direction: column; align-items: center; padding-top: 12px;
            overflow-y: auto;
        }
        .guild-icon {
            width: 48px; height: 48px; border-radius: 50%; background-color: var(--bg-dark);
            margin-bottom: 8px; cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; justify-content: center; font-weight: bold;
            background-size: cover; background-position: center;
        }
        .guild-icon:hover { border-radius: 16px; background-color: var(--accent); }
        .guild-icon.active { border-radius: 16px; border: 2px solid #fff; }
        .add-guild { color: #3ba55c; background: var(--bg-dark); font-size: 24px; }
        .add-guild:hover { background-color: #3ba55c; color: #fff; }

        /* 2. Channel/Info Sidebar (Middle Left) */
        .channel-sidebar {
            width: var(--channel-width); background: var(--bg-darker);
            display: flex; flex-direction: column;
        }
        .server-header {
            height: 48px; padding: 12px; font-weight: bold; border-bottom: 1px solid #202225;
            box-shadow: 0 1px 0 rgba(4,4,5,0.2);
        }
        .user-panel {
            margin-top: auto; background: var(--bg-darkest); padding: 10px;
            display: flex; align-items: center;
        }
        .user-avatar {
            width: 32px; height: 32px; border-radius: 50%; background: gray; margin-right: 8px;
            background-size: cover;
        }
        .user-info { flex: 1; font-size: 14px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .user-id-sub { font-size: 11px; color: var(--text-muted); font-weight: normal; }
        .settings-btn { cursor: pointer; color: var(--text-muted); }
        .settings-btn:hover { color: var(--text-main); }

        /* 3. Chat Area (Right) */
        .chat-area { flex: 1; background: var(--bg-dark); display: flex; flex-direction: column; position: relative; }
        .chat-header {
            height: 48px; padding: 0 16px; display: flex; align-items: center;
            border-bottom: 1px solid #26272d; font-weight: bold;
        }
        .messages-list {
            flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px;
        }
        .message { display: flex; gap: 10px; margin-bottom: 5px; }
        .msg-avatar { width: 40px; height: 40px; border-radius: 50%; background: #555; background-size: cover; flex-shrink: 0;}
        .msg-content h4 { font-size: 16px; margin-bottom: 4px; }
        .msg-content h4 span { font-size: 12px; color: var(--text-muted); font-weight: normal; margin-left: 8px; }
        .msg-text { font-size: 15px; word-wrap: break-word; line-height: 1.4; color: #dcddde; }

        .chat-input-area { padding: 20px; margin-bottom: 10px; }
        .chat-input-wrapper {
            background: #40444b; border-radius: 8px; padding: 10px;
        }
        .chat-input {
            width: 100%; background: transparent; border: none; color: white;
            outline: none; font-size: 15px; resize: none; height: 24px;
        }

        /* --- Modals --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 2000;
        }
        .modal { background: var(--bg-dark); padding: 25px; border-radius: 8px; width: 400px; }
        .modal h3 { margin-bottom: 15px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 12px; font-weight: bold; color: var(--text-muted); margin-bottom: 5px; text-transform: uppercase; }
        .form-control {
            width: 100%; background: #202225; border: 1px solid #202225; color: white; padding: 10px; border-radius: 4px;
        }
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: white; }
        .btn-primary { background: var(--accent); }
        .btn-secondary { background: transparent; }
        .btn-secondary:hover { text-decoration: underline; }
        .error-msg { color: #ed4245; font-size: 12px; margin-top: 5px; display: none; }

    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2>Welcome Back</h2>
            <p style="color: #bbb; margin-bottom: 20px;">We are so excited to see you again!</p>
            <div id="g_id_onload"
                data-client_id="YOUR_GOOGLE_CLIENT_ID_HERE"
                data-callback="handleCredentialResponse"
                data-auto_select="true">
            </div>
            <div class="g_id_signin" data-type="standard"></div>
        </div>
    </div>

    <div id="app-container">
        <nav class="guild-sidebar" id="guild-list">
            <div class="guild-icon active" style="background-image: url('https://via.placeholder.com/50')" onclick="switchGroup('group_1')"></div>
            <div class="guild-icon add-guild" onclick="openModal('create-join-modal')">+</div>
        </nav>

        <div class="channel-sidebar">
            <div class="server-header" id="current-group-name">General Chat</div>
            <div style="flex:1; padding: 10px; color: #72767d; font-size: 13px;">
                GROUP CODE: <span id="current-group-code" style="color:white; user-select: all;">XYZ-123</span>
            </div>
            
            <div class="user-panel">
                <div class="user-avatar" id="current-user-avatar"></div>
                <div class="user-info">
                    <div id="current-username">Username</div>
                    <div id="current-user-id" class="user-id-sub">#12345</div>
                </div>
                <div class="settings-btn" onclick="openModal('settings-modal')">⚙️</div>
            </div>
        </div>

        <main class="chat-area">
            <header class="chat-header">
                <span style="font-size:24px; margin-right: 10px; color: #72767d;">#</span>
                <span id="header-channel-name">general</span>
            </header>
            
            <div class="messages-list" id="message-scroller">
                </div>

            <div class="chat-input-area">
                <div class="chat-input-wrapper">
                    <input type="text" class="chat-input" id="msg-input" placeholder="Message #general" maxlength="200" autocomplete="off">
                </div>
                <div style="font-size: 11px; color: #72767d; margin-top: 5px;">
                    Max 200 chars. Slowmode: 2s.
                </div>
            </div>
        </main>
    </div>

    <div class="modal-overlay" id="create-join-modal">
        <div class="modal">
            <h3>Add a Server</h3>
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button class="btn btn-primary" style="flex:1" onclick="showForm('create')">Create My Own</button>
                <button class="btn btn-primary" style="flex:1; background:#4f545c" onclick="showForm('join')">Join a Group</button>
            </div>

            <div id="create-form" style="display:none;">
                <div class="form-group">
                    <label>Server Name (1-30 chars)</label>
                    <input type="text" class="form-control" id="new-group-name" maxlength="30">
                </div>
                <div class="form-group">
                    <label>Icon URL</label>
                    <input type="text" class="form-control" id="new-group-icon">
                </div>
                <button class="btn btn-primary" onclick="attemptCreateGroup()">Create</button>
            </div>

            <div id="join-form" style="display:none;">
                <div class="form-group">
                    <label>Invite Code</label>
                    <input type="text" class="form-control" id="join-group-code">
                </div>
                <button class="btn btn-primary" onclick="attemptJoinGroup()">Join Group</button>
            </div>
            
            <button class="btn btn-secondary" onclick="closeModals()" style="margin-top: 10px;">Cancel</button>
        </div>
    </div>

    <div class="modal-overlay" id="settings-modal">
        <div class="modal">
            <h3>My Account</h3>
            <div class="form-group">
                <label>Username (Unique, 3-20 chars)</label>
                <input type="text" class="form-control" id="settings-username" maxlength="20">
            </div>
            <div class="form-group">
                <label>Profile Picture URL</label>
                <input type="text" class="form-control" id="settings-avatar">
            </div>
            <button class="btn btn-primary" onclick="saveProfile()">Save Changes</button>
            <button class="btn btn-secondary" onclick="closeModals()">Close</button>
        </div>
    </div>

    <script>
        // --- STATE MANAGEMENT ---
        let currentUser = null; // Will store {id, username, avatar}
        let lastMessageTime = 0;
        
        // --- GOOGLE LOGIN CALLBACK ---
        function handleCredentialResponse(response) {
            console.log("Encoded JWT ID token: " + response.credential);
            // TODO: SEND THIS TOKEN TO YOUR VPS BACKEND
            // fetch('/api/login', { method: 'POST', body: ... })
            
            // MOCK LOGIN FOR DEMO:
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-container').style.display = 'flex';
            
            // Mock user data
            currentUser = {
                username: "NewUser",
                avatar: "https://via.placeholder.com/32",
                id: "user_" + Math.floor(Math.random() * 10000)
            };
            updateUserUI();
        }

        function updateUserUI() {
            document.getElementById('current-username').innerText = currentUser.username;
            document.getElementById('current-user-id').innerText = "#" + currentUser.id;
            document.getElementById('current-user-avatar').style.backgroundImage = `url('${currentUser.avatar}')`;
            document.getElementById('settings-username').value = currentUser.username;
            document.getElementById('settings-avatar').value = currentUser.avatar;
        }

        // --- MESSAGING LOGIC ---
        const msgInput = document.getElementById('msg-input');
        const msgList = document.getElementById('message-scroller');

        msgInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        function sendMessage() {
            const text = msgInput.value.trim();
            if (!text) return;

            // 1. Rate Limit Check (Client Side)
            const now = Date.now();
            if (now - lastMessageTime < 2000) {
                alert("You are typing too fast! Wait 2 seconds.");
                return;
            }

            // 2. Length Check
            if (text.length > 200) {
                alert("Message too long.");
                return;
            }

            // TODO: SEND TO VPS BACKEND
            // fetch('/api/message', { method: 'POST', body: JSON.stringify({ text: text }) })
            
            // Mock render message
            addMessageToDOM(currentUser.username, currentUser.avatar, text);
            
            msgInput.value = '';
            lastMessageTime = now;
        }

        function addMessageToDOM(username, avatarUrl, text) {
            const div = document.createElement('div');
            div.className = 'message';
            div.innerHTML = `
                <div class="msg-avatar" style="background-image: url('${avatarUrl}')"></div>
                <div class="msg-content">
                    <h4>${username} <span>${new Date().toLocaleTimeString()}</span></h4>
                    <div class="msg-text">${text}</div>
                </div>
            `;
            msgList.appendChild(div);
            msgList.scrollTop = msgList.scrollHeight;
        }

        // --- MODAL LOGIC ---
        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModals() { 
            document.querySelectorAll('.modal-overlay').forEach(el => el.style.display = 'none'); 
        }
        function showForm(type) {
            document.getElementById('create-form').style.display = type === 'create' ? 'block' : 'none';
            document.getElementById('join-form').style.display = type === 'join' ? 'block' : 'none';
        }

        // --- GROUP & PROFILE LOGIC (Mocks) ---
        function attemptCreateGroup() {
            const name = document.getElementById('new-group-name').value;
            if(name.length < 1 || name.length > 30) return alert("Invalid Name Length");
            
            // TODO: Call Backend to check "1 group per month" limit
            alert("Group Created! (Mock)");
            closeModals();
        }

        function attemptJoinGroup() {
            const code = document.getElementById('join-group-code').value;
            // TODO: Call Backend to verify code
            alert(`Joined group with code: ${code}`);
            closeModals();
        }

        function saveProfile() {
            const newName = document.getElementById('settings-username').value;
            const newAvatar = document.getElementById('settings-avatar').value;

            if(newName.length < 3 || newName.length > 20) return alert("Username must be 3-20 chars");

            // TODO: Call Backend to check if Username is taken
            currentUser.username = newName;
            currentUser.avatar = newAvatar;
            updateUserUI();
            closeModals();
        }
    </script>
</body>
</html>
